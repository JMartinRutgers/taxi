<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RideShare - Simple Uber Style App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #006847, #004d36);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-toggle {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            padding: 4px;
        }

        .role-toggle button {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .role-toggle button.active {
            background: white;
            color: #006847;
        }

        #map {
            flex: 1;
            position: relative;
        }

        .map-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            z-index: 500;
            display: flex;
            gap: 10px;
        }

        .info-card {
            background: white;
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            flex: 1;
            font-size: 13px;
        }

        .info-card strong {
            display: block;
            color: #006847;
            margin-bottom: 4px;
        }

        .bottom-panel {
            background: white;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding: 25px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .trip-status {
            text-align: center;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .status-badge.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.arriving {
            background: #cce5ff;
            color: #004085;
        }

        .eta-display {
            font-size: 32px;
            font-weight: bold;
            color: #006847;
            margin: 10px 0;
        }

        .eta-label {
            color: #666;
            font-size: 14px;
        }

        .share-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .share-section h3 {
            color: #006847;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-display {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .code-display input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }

        .code-display input:focus {
            outline: none;
            border-color: #006847;
        }

        .code-display button {
            padding: 15px 20px;
            background: #006847;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .code-display button:hover {
            background: #004d36;
        }

        .helper-text {
            color: #666;
            font-size: 13px;
            text-align: center;
            line-height: 1.5;
        }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #006847, #004d36);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,104,71,0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #CE1126, #a50d1e);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .trip-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .trip-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .trip-row:last-child {
            border-bottom: none;
        }

        .trip-label {
            color: #666;
            font-weight: 600;
        }

        .trip-value {
            color: #333;
            font-weight: 500;
        }

        .distance-badge {
            background: #006847;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-150px);
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            transition: transform 0.3s;
            font-weight: 600;
            max-width: 90%;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .notification.success {
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .notification.error {
            border-left: 4px solid #CE1126;
            color: #721c24;
        }

        .notification.info {
            border-left: 4px solid #0056b3;
            color: #004085;
        }

        .hide {
            display: none !important;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
            }
            
            .map-overlay {
                flex-direction: column;
            }
            
            .eta-display {
                font-size: 26px;
            }
        }

        .center-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 20px;
            color: #006847;
            z-index: 600;
            transition: all 0.3s;
        }

        .center-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><i class="fas fa-car"></i> RideShare</h1>
            <div class="role-toggle">
                <button id="driverBtn" class="active" onclick="switchRole('driver')">
                    <i class="fas fa-steering-wheel"></i> Driver
                </button>
                <button id="customerBtn" onclick="switchRole('customer')">
                    <i class="fas fa-user"></i> Rider
                </button>
            </div>
        </div>

        <div id="map">
            <div class="map-overlay hide" id="mapOverlay">
                <div class="info-card">
                    <strong><i class="fas fa-route"></i> Distance</strong>
                    <span id="distanceDisplay">--</span>
                </div>
                <div class="info-card">
                    <strong><i class="fas fa-clock"></i> ETA</strong>
                    <span id="etaDisplay">--</span>
                </div>
            </div>
            <button class="center-btn hide" id="centerBtn" onclick="centerMap()">
                <i class="fas fa-location-crosshairs"></i>
            </button>
        </div>

        <div class="bottom-panel">
            <!-- Driver View -->
            <div id="driverPanel">
                <div class="trip-status">
                    <div class="status-badge waiting" id="driverStatus">
                        <i class="fas fa-circle-notch"></i>
                        <span>Waiting for Rider</span>
                    </div>
                </div>

                <div class="share-section">
                    <h3><i class="fas fa-qrcode"></i> Your Ride Code</h3>
                    <div class="code-display">
                        <input type="text" id="driverCode" readonly>
                        <button onclick="copyCode()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p class="helper-text">Share this code with your rider so they can track you</p>
                </div>

                <button class="btn-primary" id="startDrivingBtn" onclick="startTrip()">
                    <i class="fas fa-play"></i> Start Trip
                </button>

                <div class="trip-info hide" id="driverTripInfo">
                    <div class="trip-row">
                        <span class="trip-label"><i class="fas fa-location-dot"></i> Your Location</span>
                        <span class="trip-value" id="driverLocation">Getting...</span>
                    </div>
                    <div class="trip-row">
                        <span class="trip-label"><i class="fas fa-user-check"></i> Rider Location</span>
                        <span class="trip-value" id="riderLocation">Waiting...</span>
                    </div>
                    <div class="trip-row">
                        <span class="trip-label"><i class="fas fa-gauge-high"></i> Status</span>
                        <span class="trip-value"><span class="pulse-dot"></span>Active</span>
                    </div>
                </div>

                <button class="btn-primary btn-danger hide" id="endTripBtn" onclick="endTrip()">
                    <i class="fas fa-flag-checkered"></i> End Trip
                </button>
            </div>

            <!-- Customer/Rider View -->
            <div id="customerPanel" class="hide">
                <div class="trip-status">
                    <div class="status-badge waiting" id="customerStatus">
                        <i class="fas fa-search"></i>
                        <span>Enter Driver Code</span>
                    </div>
                    <div class="eta-display hide" id="etaTime">-- min</div>
                    <div class="eta-label hide" id="etaLabel">Estimated arrival</div>
                </div>

                <div class="share-section">
                    <h3><i class="fas fa-link"></i> Connect to Driver</h3>
                    <div class="code-display">
                        <input type="text" id="riderCodeInput" placeholder="Enter code (e.g., DRV-5UXM)" maxlength="8">
                        <button onclick="connectToDriver()">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <p class="helper-text">Get the code from your driver to start tracking</p>
                </div>

                <button class="btn-primary hide" id="shareLocationBtn" onclick="shareRiderLocation()">
                    <i class="fas fa-location-arrow"></i> Share My Location
                </button>

                <div class="trip-info hide" id="customerTripInfo">
                    <div class="trip-row">
                        <span class="trip-label"><i class="fas fa-map-pin"></i> Your Location</span>
                        <span class="trip-value" id="riderYourLocation">Getting...</span>
                    </div>
                    <div class="trip-row">
                        <span class="trip-label"><i class="fas fa-car"></i> Driver Location</span>
                        <span class="trip-value" id="driverLocationForRider">Waiting...</span>
                    </div>
                    <div class="trip-row">
                        <span class="trip-label"><i class="fas fa-road"></i> Distance</span>
                        <span class="trip-value">
                            <span class="distance-badge" id="distanceBadge">--</span>
                        </span>
                    </div>
                </div>

                <button class="btn-primary btn-danger hide" id="cancelTripBtn" onclick="endTrip()">
                    <i class="fas fa-times"></i> Cancel Trip
                </button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        // Global state
        let map;
        let driverMarker = null;
        let riderMarker = null;
        let routeLine = null;
        let currentRole = 'driver';
        let tripActive = false;
        let driverLocation = null;
        let riderLocation = null;
        let watchId = null;
        let connectedCode = null;
        let simulationInterval = null;

        // Initialize app
        function init() {
            // Initialize map centered on Mexico City
            map = L.map('map').setView([19.4326, -99.1332], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            generateDriverCode();
            
            // Add event listener for Enter key in rider code input
            document.getElementById('riderCodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    connectToDriver();
                }
            });
            
            console.log('RideShare app initialized');
        }

        // Generate unique driver code
        function generateDriverCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'DRV-';
            for (let i = 0; i < 4; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            document.getElementById('driverCode').value = code;
            return code;
        }

        // Copy code to clipboard
        function copyCode() {
            const input = document.getElementById('driverCode');
            input.select();
            input.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('Code copied! Share it with your rider', 'success');
            } catch (err) {
                showNotification('Code copied to clipboard', 'success');
            }
        }

        // Switch between driver and rider roles
        function switchRole(role) {
            if (tripActive) {
                showNotification('End current trip before switching roles', 'error');
                return;
            }

            currentRole = role;

            // Update UI
            document.getElementById('driverBtn').classList.toggle('active', role === 'driver');
            document.getElementById('customerBtn').classList.toggle('active', role === 'customer');
            document.getElementById('driverPanel').classList.toggle('hide', role === 'customer');
            document.getElementById('customerPanel').classList.toggle('hide', role === 'driver');

            // Reset UI elements when switching roles
            resetUI();
            
            showNotification(`Switched to ${role === 'driver' ? 'Driver' : 'Rider'} mode`, 'info');
        }

        // Reset UI elements
        function resetUI() {
            // Clear markers
            if (driverMarker) {
                map.removeLayer(driverMarker);
                driverMarker = null;
            }
            if (riderMarker) {
                map.removeLayer(riderMarker);
                riderMarker = null;
            }
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
            
            // Reset location data
            driverLocation = null;
            riderLocation = null;
            connectedCode = null;
            
            // Clear simulation interval
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            // Reset UI elements
            document.getElementById('mapOverlay').classList.add('hide');
            document.getElementById('centerBtn').classList.add('hide');
            document.getElementById('driverTripInfo').classList.add('hide');
            document.getElementById('customerTripInfo').classList.add('hide');
            document.getElementById('endTripBtn').classList.add('hide');
            document.getElementById('cancelTripBtn').classList.add('hide');
            document.getElementById('etaTime').classList.add('hide');
            document.getElementById('etaLabel').classList.add('hide');
            document.getElementById('shareLocationBtn').classList.add('hide');
            
            // Reset status badges
            document.getElementById('driverStatus').innerHTML = '<i class="fas fa-circle-notch"></i><span>Waiting for Rider</span>';
            document.getElementById('driverStatus').className = 'status-badge waiting';
            document.getElementById('customerStatus').innerHTML = '<i class="fas fa-search"></i><span>Enter Driver Code</span>';
            document.getElementById('customerStatus').className = 'status-badge waiting';
            
            // Reset buttons
            document.getElementById('startDrivingBtn').disabled = false;
            document.getElementById('shareLocationBtn').disabled = false;
            
            // Reset input
            document.getElementById('riderCodeInput').value = '';
            
            // Reset displays
            document.getElementById('distanceDisplay').textContent = '--';
            document.getElementById('etaDisplay').textContent = '--';
            document.getElementById('etaTime').textContent = '-- min';
            document.getElementById('distanceBadge').textContent = '--';
        }

        // Connect rider to driver
        function connectToDriver() {
            const code = document.getElementById('riderCodeInput').value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Please enter a driver code', 'error');
                return;
            }

            if (!code.match(/^DRV-[A-Z0-9]{4}$/)) {
                showNotification('Invalid code format. Use: DRV-XXXX', 'error');
                return;
            }

            connectedCode = code;
            
            // Update UI
            document.getElementById('customerStatus').innerHTML = '<i class="fas fa-check-circle"></i><span>Connected to Driver</span>';
            document.getElementById('customerStatus').classList.remove('waiting');
            document.getElementById('customerStatus').classList.add('active');
            document.getElementById('shareLocationBtn').classList.remove('hide');
            
            showNotification(`Connected to driver ${code}`, 'success');
            
            // Start tracking driver (simulated)
            setTimeout(() => {
                if (connectedCode) {
                    simulateDriverMovement();
                }
            }, 1000);
        }

        // Start trip (Driver)
        function startTrip() {
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported', 'error');
                return;
            }

            tripActive = true;

            // Update UI
            document.getElementById('startDrivingBtn').disabled = true;
            document.getElementById('driverTripInfo').classList.remove('hide');
            document.getElementById('endTripBtn').classList.remove('hide');
            document.getElementById('driverStatus').innerHTML = '<i class="fas fa-car"></i><span>Trip Active</span>';
            document.getElementById('driverStatus').classList.remove('waiting');
            document.getElementById('driverStatus').classList.add('active');
            document.getElementById('mapOverlay').classList.remove('hide');
            document.getElementById('centerBtn').classList.remove('hide');

            // Start location tracking
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateDriverLocation(position);
                    
                    watchId = navigator.geolocation.watchPosition(
                        updateDriverLocation,
                        handleLocationError,
                        {
                            enableHighAccuracy: true,
                            maximumAge: 5000,
                            timeout: 10000
                        }
                    );

                    // Simulate rider after 2 seconds
                    setTimeout(simulateRiderLocation, 2000);
                },
                handleLocationError
            );

            showNotification('Trip started - Tracking your location', 'success');
        }

        // Share rider location
        function shareRiderLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported', 'error');
                return;
            }

            if (!connectedCode) {
                showNotification('Connect to a driver first', 'error');
                return;
            }

            tripActive = true;

            // Update UI
            document.getElementById('shareLocationBtn').disabled = true;
            document.getElementById('customerTripInfo').classList.remove('hide');
            document.getElementById('cancelTripBtn').classList.remove('hide');
            document.getElementById('etaTime').classList.remove('hide');
            document.getElementById('etaLabel').classList.remove('hide');
            document.getElementById('mapOverlay').classList.remove('hide');
            document.getElementById('centerBtn').classList.remove('hide');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateRiderLocation(position);
                    
                    watchId = navigator.geolocation.watchPosition(
                        updateRiderLocation,
                        handleLocationError,
                        {
                            enableHighAccuracy: true,
                            maximumAge: 5000,
                            timeout: 10000
                        }
                    );
                },
                handleLocationError
            );

            showNotification('Sharing your location with driver', 'success');
        }

        // Update driver location
        function updateDriverLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            driverLocation = { lat, lng };

            // Create/update driver marker
            const icon = L.divIcon({
                html: `<div style="background: #006847; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-size: 18px;">
                    <i class="fas fa-car"></i>
                </div>`,
                iconSize: [45, 45],
                iconAnchor: [22.5, 22.5]
            });

            if (driverMarker) {
                driverMarker.setLatLng([lat, lng]);
            } else {
                driverMarker = L.marker([lat, lng], { icon }).addTo(map);
                map.setView([lat, lng], 15);
            }

            // Update UI
            document.getElementById('driverLocation').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            updateTripDetails();
        }

        // Update rider location
        function updateRiderLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            riderLocation = { lat, lng };

            // Create/update rider marker
            const icon = L.divIcon({
                html: `<div style="background: #CE1126; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-size: 18px;">
                    <i class="fas fa-user"></i>
                </div>`,
                iconSize: [45, 45],
                iconAnchor: [22.5, 22.5]
            });

            if (riderMarker) {
                riderMarker.setLatLng([lat, lng]);
            } else {
                riderMarker = L.marker([lat, lng], { icon }).addTo(map);
                map.setView([lat, lng], 15);
            }

            // Update UI
            document.getElementById('riderYourLocation').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            updateTripDetails();
        }

        // Simulate driver movement (for rider view)
        function simulateDriverMovement() {
            if (!riderLocation) {
                setTimeout(simulateDriverMovement, 1000);
                return;
            }

            // Place driver nearby (within 3km)
            const offset = 0.02;
            driverLocation = {
                lat: riderLocation.lat + (Math.random() - 0.5) * offset,
                lng: riderLocation.lng + (Math.random() - 0.5) * offset
            };

            const icon = L.divIcon({
                html: `<div style="background: #006847; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-size: 18px;">
                    <i class="fas fa-car"></i>
                </div>`,
                iconSize: [45, 45],
                iconAnchor: [22.5, 22.5]
            });

            driverMarker = L.marker([driverLocation.lat, driverLocation.lng], { icon }).addTo(map);

            document.getElementById('driverLocationForRider').textContent = 
                `${driverLocation.lat.toFixed(4)}, ${driverLocation.lng.toFixed(4)}`;

            updateTripDetails();

            // Animate driver moving towards rider
            simulationInterval = setInterval(() => {
                if (!tripActive || !driverLocation || !riderLocation) return;

                const dx = (riderLocation.lat - driverLocation.lat) * 0.1;
                const dy = (riderLocation.lng - driverLocation.lng) * 0.1;
                
                driverLocation.lat += dx;
                driverLocation.lng += dy;

                driverMarker.setLatLng([driverLocation.lat, driverLocation.lng]);
                document.getElementById('driverLocationForRider').textContent = 
                    `${driverLocation.lat.toFixed(4)}, ${driverLocation.lng.toFixed(4)}`;

                updateTripDetails();
            }, 2000);
        }

        // Simulate rider location (for driver view)
        function simulateRiderLocation() {
            if (!driverLocation) return;

            const offset = 0.015;
            riderLocation = {
                lat: driverLocation.lat + (Math.random() - 0.5) * offset,
                lng: driverLocation.lng + (Math.random() - 0.5) * offset
            };

            const icon = L.divIcon({
                html: `<div style="background: #CE1126; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-size: 18px;">
                    <i class="fas fa-user"></i>
                </div>`,
                iconSize: [45, 45],
                iconAnchor: [22.5, 22.5]
            });

            riderMarker = L.marker([riderLocation.lat, riderLocation.lng], { icon }).addTo(map);

            document.getElementById('riderLocation').textContent = 
                `${riderLocation.lat.toFixed(4)}, ${riderLocation.lng.toFixed(4)}`;

            updateTripDetails();
        }

        // Update trip details (distance, ETA, route)
        function updateTripDetails() {
            if (!driverLocation || !riderLocation) return;

            // Calculate distance
            const distance = calculateDistance(
                driverLocation.lat, driverLocation.lng,
                riderLocation.lat, riderLocation.lng
            );

            const distText = distance < 1 ? 
                `${Math.round(distance * 1000)} m` : 
                `${distance.toFixed(1)} km`;

            // Update distance displays
            document.getElementById('distanceDisplay').textContent = distText;
            document.getElementById('distanceBadge').textContent = distText;

            // Calculate ETA (assuming 40 km/h average speed)
            const eta = Math.ceil((distance / 40) * 60); // minutes
            document.getElementById('etaDisplay').textContent = `${eta} min`;
            document.getElementById('etaTime').textContent = `${eta} min`;

            // Update route line
            if (routeLine) {
                map.removeLayer(routeLine);
            }

            routeLine = L.polyline([
                [driverLocation.lat, driverLocation.lng],
                [riderLocation.lat, riderLocation.lng]
            ], {
                color: '#F7B718',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Fit map to show both locations
            const bounds = L.latLngBounds([
                [driverLocation.lat, driverLocation.lng],
                [riderLocation.lat, riderLocation.lng]
            ]);
            map.fitBounds(bounds, { padding: [80, 80] });
        }

        // Calculate distance between two points using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Handle location errors
        function handleLocationError(error) {
            let message = 'Unknown location error';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please enable location services.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out.';
                    break;
            }
            
            showNotification(message, 'error');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Center map on user location
        function centerMap() {
            if (currentRole === 'driver' && driverLocation) {
                map.setView([driverLocation.lat, driverLocation.lng], 15);
            } else if (currentRole === 'customer' && riderLocation) {
                map.setView([riderLocation.lat, riderLocation.lng], 15);
            } else {
                showNotification('Location not available', 'error');
            }
        }

        // End trip
        function endTrip() {
            tripActive = false;
            
            // Stop location tracking
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Stop simulation
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            // Reset UI
            resetUI();
            
            showNotification('Trip ended', 'info');
        }

        // Initialize app when page loads
        window.onload = init;
    </script>
</body>
</html>
