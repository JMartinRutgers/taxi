<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocationShare - Driver & Customer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #006847;
            --secondary: #CE1126;
            --accent: #F7B718;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, #004d36 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            height: 95vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--light);
        }

        .header h1 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .tagline {
            color: var(--secondary);
            font-size: 14px;
            margin-top: 5px;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .controls {
            padding: 20px;
            background: var(--light);
            border-top: 2px solid #e9ecef;
        }

        .user-type {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .user-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), #004d36);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,104,71,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--secondary), #a50d1e);
        }

        .location-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: #333;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--secondary), #c82333);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--accent), #fd7e14);
        }

        .share-section {
            display: none;
            margin-top: 15px;
        }

        .share-code {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .share-code input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .share-code button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
        }

        .connection-status {
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            font-weight: 600;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><i class="fas fa-location-dot"></i> LocationShare</h1>
            <div class="tagline">See driver and customer locations in real-time</div>
        </div>

        <div id="map"></div>

        <div class="controls">
            <div class="user-type">
                <button class="user-btn active" id="driverBtn" onclick="setUserType('driver')">
                    <i class="fas fa-car"></i> I'm a Driver
                </button>
                <button class="user-btn" id="customerBtn" onclick="setUserType('customer')">
                    <i class="fas fa-user"></i> I'm a Customer
                </button>
            </div>

            <div id="driverControls">
                <button class="btn" onclick="startSharingLocation()" id="shareLocationBtn">
                    <i class="fas fa-share-alt"></i> Share My Location
                </button>
                <div class="share-code">
                    <input type="text" id="shareCode" value="DRV-5A8B" readonly>
                    <button onclick="copyShareCode()"><i class="fas fa-copy"></i></button>
                </div>
                <p style="text-align: center; font-size: 14px; color: #666; margin: 10px 0;">
                    Give this code to your customer to connect
                </p>
            </div>

            <div id="customerControls" style="display: none;">
                <div class="share-code">
                    <input type="text" id="customerCode" placeholder="Enter driver code">
                    <button onclick="connectToDriver()"><i class="fas fa-link"></i></button>
                </div>
                <button class="btn" onclick="startSharingLocation()" id="customerShareBtn">
                    <i class="fas fa-share-alt"></i> Share My Location With Driver
                </button>
            </div>

            <div class="connection-status" id="connectionStatus" style="display: none;">
                <i class="fas fa-circle"></i> <span id="statusText">Connected to Driver</span>
            </div>

            <div class="location-info" id="locationInfo">
                <div class="info-item">
                    <span class="info-label">Your Location:</span>
                    <span class="info-value" id="yourCoords">Getting location...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Other's Location:</span>
                    <span class="info-value" id="otherCoords">Waiting for connection...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Distance:</span>
                    <span class="info-value" id="distance">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Updated:</span>
                    <span class="info-value" id="lastUpdate">--</span>
                </div>
            </div>

            <button class="btn btn-danger" onclick="stopSharing()" id="stopBtn" style="display: none;">
                <i class="fas fa-stop"></i> Stop Sharing
            </button>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map, yourMarker, otherMarker, connectionLine;
        let isSharing = false;
        let userType = 'driver';
        let trackingInterval = null;
        let shareCode = '';
        let otherUserLocation = null;
        let yourLocation = null;

        // Initialize the application
        function init() {
            initMap();
            generateShareCode();
            showNotification('Select your role (Driver or Customer)', 'warning');
        }

        // Initialize the map
        function initMap() {
            // Default to Mexico City
            map = L.map('map').setView([19.4326, -99.1332], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Create markers but don't add them yet
            yourMarker = L.marker([0, 0], {
                icon: createCustomIcon(userType === 'driver' ? 'driver' : 'customer')
            });

            otherMarker = L.marker([0, 0], {
                icon: createCustomIcon(userType === 'driver' ? 'customer' : 'driver')
            });
        }

        // Create custom icons for markers
        function createCustomIcon(type) {
            const iconColor = type === 'driver' ? '#006847' : '#CE1126';
            const iconHtml = type === 'driver' ? 
                '<i class="fas fa-car"></i>' : 
                '<i class="fas fa-user"></i>';
            
            return L.divIcon({
                html: `<div style="background-color: ${iconColor}; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">${iconHtml}</div>`,
                className: 'custom-div-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        }

        // Set user type (driver or customer)
        function setUserType(type) {
            userType = type;
            
            // Update UI
            document.getElementById('driverBtn').classList.toggle('active', type === 'driver');
            document.getElementById('customerBtn').classList.toggle('active', type === 'customer');
            document.getElementById('driverControls').style.display = type === 'driver' ? 'block' : 'none';
            document.getElementById('customerControls').style.display = type === 'customer' ? 'block' : 'none';
            
            // Update markers
            yourMarker.setIcon(createCustomIcon(type));
            otherMarker.setIcon(createCustomIcon(type === 'driver' ? 'customer' : 'driver'));
            
            // Reset if sharing was active
            if (isSharing) {
                stopSharing();
            }
            
            showNotification(`You are now set as ${type}`, 'success');
        }

        // Generate a share code
        function generateShareCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            shareCode = 'DRV-' + code;
            document.getElementById('shareCode').value = shareCode;
        }

        // Copy share code to clipboard
        function copyShareCode() {
            const codeInput = document.getElementById('shareCode');
            codeInput.select();
            document.execCommand('copy');
            showNotification('Share code copied to clipboard!', 'success');
        }

        // Connect to driver (for customer)
        function connectToDriver() {
            const code = document.getElementById('customerCode').value.trim().toUpperCase();
            if (!code) {
                showNotification('Please enter a driver code', 'error');
                return;
            }
            
            // In a real app, you would validate this code with a server
            // For demo, we'll accept any code starting with DRV-
            if (code.startsWith('DRV-')) {
                document.getElementById('connectionStatus').style.display = 'block';
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
                document.getElementById('statusText').textContent = `Connected to Driver: ${code}`;
                showNotification('Connected to driver!', 'success');
                
                // Simulate receiving driver location
                simulateOtherUserLocation();
            } else {
                showNotification('Invalid driver code format', 'error');
            }
        }

        // Start sharing location
        function startSharingLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by your device', 'error');
                return;
            }

            isSharing = true;
            
            // Update UI
            document.getElementById('shareLocationBtn').disabled = true;
            document.getElementById('customerShareBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('locationInfo').style.display = 'block';
            
            // Start tracking location
            trackingInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    position => updateYourLocation(position),
                    handleLocationError,
                    { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }, 5000); // Update every 5 seconds
            
            // Get initial location
            navigator.geolocation.getCurrentPosition(
                position => updateYourLocation(position),
                handleLocationError,
                { enableHighAccuracy: true }
            );
            
            showNotification('Sharing your location...', 'success');
        }

        // Update your location on the map
        function updateYourLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            yourLocation = { lat, lng };
            
            // Update marker
            if (!map.hasLayer(yourMarker)) {
                yourMarker.setLatLng([lat, lng]).addTo(map);
            } else {
                yourMarker.setLatLng([lat, lng]);
            }
            
            // Center map on your location if it's the first time
            if (!isSharing) {
                map.setView([lat, lng], 15);
            }
            
            // Update location info
            document.getElementById('yourCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Update distance if other user location is available
            if (otherUserLocation) {
                updateDistance();
            }
            
            // In a real app, you would send this location to a server
            // For demo, we'll just log it
            console.log(`${userType} location:`, { lat, lng });
        }

        // Simulate other user location (for demo)
        function simulateOtherUserLocation() {
            if (!yourLocation) return;
            
            // Simulate other user being nearby (within 2km)
            const offsetLat = (Math.random() - 0.5) * 0.02; // ~2km
            const offsetLng = (Math.random() - 0.5) * 0.02; // ~2km
            
            otherUserLocation = {
                lat: yourLocation.lat + offsetLat,
                lng: yourLocation.lng + offsetLng
            };
            
            // Update marker
            if (!map.hasLayer(otherMarker)) {
                otherMarker.setLatLng([otherUserLocation.lat, otherUserLocation.lng]).addTo(map);
            } else {
                otherMarker.setLatLng([otherUserLocation.lat, otherUserLocation.lng]);
            }
            
            // Update connection line
            if (yourLocation && otherUserLocation) {
                if (connectionLine) {
                    map.removeLayer(connectionLine);
                }
                
                connectionLine = L.polyline([
                    [yourLocation.lat, yourLocation.lng],
                    [otherUserLocation.lat, otherUserLocation.lng]
                ], {
                    color: '#F7B718',
                    weight: 3,
                    dashArray: '5, 10'
                }).addTo(map);
            }
            
            // Update location info
            document.getElementById('otherCoords').textContent = 
                `${otherUserLocation.lat.toFixed(6)}, ${otherUserLocation.lng.toFixed(6)}`;
            
            updateDistance();
            
            // Simulate movement every 10 seconds
            setTimeout(simulateOtherUserLocation, 10000);
        }

        // Update distance between users
        function updateDistance() {
            if (!yourLocation || !otherUserLocation) return;
            
            const distance = calculateDistance(
                yourLocation.lat, yourLocation.lng,
                otherUserLocation.lat, otherUserLocation.lng
            );
            
            document.getElementById('distance').textContent = 
                distance < 1 ? 
                `${(distance * 1000).toFixed(0)} meters` : 
                `${distance.toFixed(2)} km`;
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Stop sharing location
        function stopSharing() {
            isSharing = false;
            
            // Stop tracking
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            // Update UI
            document.getElementById('shareLocationBtn').disabled = false;
            document.getElementById('customerShareBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('connectionStatus').style.display = 'none';
            
            // Remove markers and line
            if (map.hasLayer(yourMarker)) {
                map.removeLayer(yourMarker);
            }
            if (map.hasLayer(otherMarker)) {
                map.removeLayer(otherMarker);
            }
            if (connectionLine) {
                map.removeLayer(connectionLine);
                connectionLine = null;
            }
            
            // Reset locations
            yourLocation = null;
            otherUserLocation = null;
            
            showNotification('Location sharing stopped', 'warning');
        }

        // Handle location errors
        function handleLocationError(error) {
            let message = 'Unable to get your location: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Location access denied. Please allow location permissions.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Location unavailable.';
                    break;
                case error.TIMEOUT:
                    message += 'Location request timeout.';
                    break;
                default:
                    message += 'Unknown error.';
            }
            showNotification(message, 'error');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
